<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãˆã™é¯–ã‹ãã‚Œã‚“ã¼å¤§ä¼šï¼ï¼</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "BIZ UDPGothic", sans-serif; background-color: #f0f4f8; color: #333; max-width: 950px; margin: 0 auto; padding: 10px; }
        h1 { text-align: center; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; font-size: 1.5rem; }
        .container { display: flex; gap: 15px; flex-wrap: wrap; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex: 1; min-width: 300px; }
        h3 { margin-top: 0; color: #34495e; border-left: 5px solid #3498db; padding-left: 10px; font-size: 1.1rem; }
        .member-input { margin-bottom: 5px; display: block; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .score-row { border-bottom: 1px solid #eee; padding: 12px 0; }
        .bonus-group { font-size: 0.8em; margin-top: 8px; color: #555; display: flex; gap: 8px; flex-wrap: wrap; }
        .bonus-item { display: flex; align-items: center; gap: 3px; background: #eef7ff; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        select, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem; }
        button { background-color: #3498db; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background-color: #2980b9; }
        .reset-btn { background-color: #e74c3c; margin-top: 10px; font-size: 0.8em; opacity: 0.7; }
        .reset-btn:hover { background-color: #c0392b; opacity: 1; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #3498db; color: white; }
    </style>
</head>
<body>

    <h1>ğŸ® ãˆã™é¯–ã‹ãã‚Œã‚“ã¼å¤§ä¼šï¼ï¼</h1>

    <div class="container">
        <div class="card" id="memberCard">
            <h3>1. å‚åŠ è€…ç™»éŒ²</h3>
            <div id="memberInputs"></div>
            <button onclick="updateMemberList()" style="width: 100%; margin-top: 10px;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç¢ºå®šãƒ»æ ã‚’éš ã™</button>
            <button onclick="showAllInputs()" style="width: 100%; margin-top: 5px; background-color: #95a5a6;">åå‰ã‚’ç·¨é›†ã™ã‚‹</button>
        </div>

        <div class="card">
            <h3>2. è©¦åˆçµæœã®å…¥åŠ›</h3>
            <div class="score-row" style="background: #fff5f5; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                <strong>ğŸ‘¹ é¬¼:</strong>
                <select id="oniSelect"><option value="">é¸æŠ</option></select>
                <span style="margin-left:10px;">ç²å¾—: <strong id="oniTotalDisplay">0</strong> pt</span>
            </div>
            <div id="childrenInputs"></div>
            <button onclick="saveMatch()" id="saveBtn" style="width: 100%; background-color: #e67e22; margin-top: 15px; height: 50px; font-size: 1.1em;">è©¦åˆçµæœã‚’ä¿å­˜ãƒ»é›†è¨ˆ</button>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>3. ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
            <button onclick="clearRanking()" class="reset-btn">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        <table id="rankingTable">
            <thead>
                <tr><th>é †ä½</th><th>åå‰</th><th>ç·åˆãƒã‚¤ãƒ³ãƒˆ</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="3">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // ã‚ãªãŸã®GASã®URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyeOjRnBXKKDQS_f_uNam_TZ5yI7uZ5rELyxcS-BKjjIF2Mo4OeuRFg6ieOaqpJl8Xm/exec"; 

        document.addEventListener("DOMContentLoaded", function() {
            initForm();
            loadSavedNames(); // ä¿å­˜ã•ã‚ŒãŸåå‰ã‚’å‘¼ã³å‡ºã™
            fetchRanking();
        });

        function initForm() {
            const mDiv = document.getElementById('memberInputs');
            const cDiv = document.getElementById('childrenInputs');

            let mHtml = "";
            for (let i = 1; i <= 10; i++) {
                mHtml += `<input type="text" class="member-input" id="m${i}" placeholder="å‚åŠ è€… ${i}" onchange="saveNamesToLocal()">`;
            }
            mDiv.innerHTML = mHtml;

            let cHtml = "";
            for (let i = 1; i <= 4; i++) {
                cHtml += `
                <div class="score-row">
                    <div>
                        ğŸƒ å­${i}: <select id="ko${i}Select" class="ko-sel"><option value="">é¸æŠ</option></select>
                        <select id="ko${i}Time" onchange="calculatePoints()">
                            <option value="0">3~2åˆ†(0pt)</option>
                            <option value="1">2~1åˆ†(1pt)</option>
                            <option value="2">1åˆ†~çµ‚äº†(2pt)</option>
                            <option value="3">é€ƒã’åˆ‡ã‚Š(3pt)</option>
                        </select>
                    </div>
                    <div class="bonus-group">
                        <label class="bonus-item"><input type="checkbox" id="ko${i}B1" onchange="calculatePoints()"> æ•µé™£(+0.5)</label>
                        <label class="bonus-item"><input type="checkbox" id="ko${i}B2" onchange="calculatePoints()"> æœ€æ•µé™£(+0.5)</label>
                    </div>
                </div>`;
            }
            cDiv.innerHTML = cHtml;
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶ã«åå‰ã‚’ä¿å­˜
        function saveNamesToLocal() {
            const names = [];
            for (let i = 1; i <= 10; i++) {
                names.push(document.getElementById(`m${i}`).value);
            }
            localStorage.setItem('esuSabaNames', JSON.stringify(names));
        }

        // ä¿å­˜ã•ã‚ŒãŸåå‰ã‚’èª­ã¿è¾¼ã‚€
        function loadSavedNames() {
            const saved = localStorage.getItem('esuSabaNames');
            if (saved) {
                const names = JSON.parse(saved);
                names.forEach((name, i) => {
                    if (document.getElementById(`m${i+1}`)) {
                        document.getElementById(`m${i+1}`).value = name;
                    }
                });
                updateMemberList(); // åå‰ãŒã‚ã‚Œã°è‡ªå‹•çš„ã«ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³åæ˜ ï¼‹æ æ¶ˆã—
            }
        }

        function updateMemberList() {
            const names = [];
            for (let i = 1; i <= 10; i++) {
                const input = document.getElementById(`m${i}`);
                const val = input.value.trim();
                if (val) {
                    names.push(val);
                } else {
                    input.style.display = "none"; // ç©ºã®æ ã‚’æ¶ˆã™
                }
            }
            
            const dropdowns = [document.getElementById('oniSelect'), ...document.querySelectorAll('.ko-sel')];
            dropdowns.forEach(select => {
                const currentVal = select.value;
                select.innerHTML = '<option value="">é¸æŠ</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');
                select.value = currentVal;
            });
        }

        function showAllInputs() {
            for (let i = 1; i <= 10; i++) {
                document.getElementById(`m${i}`).style.display = "block";
            }
        }

        async function fetchRanking() {
            try {
                const response = await fetch(GAS_URL);
                const scores = await response.json();
                updateRanking(scores);
            } catch (e) {
                console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
            }
        }

        function calculatePoints() {
            let oniBonus = 0;
            for (let i = 1; i <= 4; i++) {
                const timeVal = parseInt(document.getElementById(`ko${i}Time`).value);
                if (timeVal === 0) oniBonus += 3;
                else if (timeVal === 1) oniBonus += 2;
                else if (timeVal === 2) oniBonus += 1;
            }
            document.getElementById('oniTotalDisplay').innerText = oniBonus;
            return oniBonus;
        }

        async function saveMatch() {
            const oniName = document.getElementById('oniSelect').value;
            if (!oniName) { alert("é¬¼ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerText = "ä¿å­˜ä¸­...";

            const matchData = {
                action: "save",
                oniName: oniName,
                oniPoints: calculatePoints(),
                children: []
            };

            for (let i = 1; i <= 4; i++) {
                const name = document.getElementById(`ko${i}Select`).value;
                if (!name) continue;
                let p = parseInt(document.getElementById(`ko${i}Time`).value);
                if (document.getElementById(`ko${i}B1`).checked) p += 0.5;
                if (document.getElementById(`ko${i}B2`).checked) p += 0.5;
                matchData.children.push({ name: name, points: p });
            }

            try {
                await fetch(GAS_URL, { method: "POST", body: JSON.stringify(matchData) });
                alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
                fetchRanking();
                resetForm();
            } catch (e) { alert("å¤±æ•—ã—ã¾ã—ãŸ"); }
            finally { btn.disabled = false; btn.innerText = "è©¦åˆçµæœã‚’ä¿å­˜ãƒ»é›†è¨ˆ"; }
        }

        async function clearRanking() {
            if(!confirm("ã€æ³¨æ„ã€‘ã™ã¹ã¦ã®è©¦åˆãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
            try {
                await fetch(GAS_URL, { method: "POST", body: JSON.stringify({action: "clear"}) });
                alert("ãƒªã‚»ãƒƒãƒˆå®Œäº†ã—ã¾ã—ãŸ");
                fetchRanking();
            } catch (e) { alert("ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"); }
        }

        function resetForm() {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`ko${i}B1`).checked = false;
                document.getElementById(`ko${i}B2`).checked = false;
                document.getElementById(`ko${i}Time`).value = "0";
                document.getElementById(`ko${i}Select`).value = "";
            }
            document.getElementById('oniSelect').value = "";
            calculatePoints();
        }

        function updateRanking(scores) {
            const tbody = document.querySelector('#rankingTable tbody');
            tbody.innerHTML = '';
            const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            sorted.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${index + 1}</td><td>${item[0]}</td><td>${item[1].toFixed(1)} pt</td>`;
            });
        }
    </script>
</body>
</html>
