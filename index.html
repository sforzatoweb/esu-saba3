<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãˆã™é¯–ã‹ãã‚Œã‚“ã¼å¤§ä¼šï¼ï¼</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "BIZ UDPGothic", sans-serif; background-color: #f0f4f8; color: #333; max-width: 950px; margin: 0 auto; padding: 10px; }
        h1 { text-align: center; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; font-size: 1.5rem; }
        .container { display: flex; gap: 15px; flex-wrap: wrap; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex: 1; min-width: 300px; }
        h3 { margin-top: 0; color: #34495e; border-left: 5px solid #3498db; padding-left: 10px; font-size: 1.1rem; }
        .member-input { margin-bottom: 5px; display: block; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .score-row { border-bottom: 1px solid #eee; padding: 12px 0; }
        .bonus-group { font-size: 0.8em; margin-top: 8px; color: #555; display: flex; gap: 8px; flex-wrap: wrap; }
        .bonus-item { display: flex; align-items: center; gap: 3px; background: #eef7ff; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
        select, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9rem; }
        button { background-color: #3498db; color: white; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #ccc; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; font-size: 0.9rem; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>

    <h1>ğŸ® ãˆã™é¯–ã‹ãã‚Œã‚“ã¼å¤§ä¼šï¼ï¼</h1>

    <div class="container">
        <div class="card">
            <h3>1. å‚åŠ è€…ç™»éŒ² (10å)</h3>
            <div id="memberInputs"></div>
            <button onclick="updateMemberList()" style="width: 100%; margin-top: 10px;">ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’ç¢ºå®š</button>
        </div>

        <div class="card">
            <h3>2. è©¦åˆçµæœã®å…¥åŠ›</h3>
            <div class="score-row" style="background: #fff5f5; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                <strong>ğŸ‘¹ é¬¼:</strong>
                <select id="oniSelect"><option value="">é¸æŠ</option></select>
                <span style="margin-left:10px;">ç²å¾—: <strong id="oniTotalDisplay">0</strong> pt</span>
            </div>
            <div id="childrenInputs"></div>
            <button onclick="saveMatch()" id="saveBtn" style="width: 100%; background-color: #e67e22; margin-top: 15px; height: 50px; font-size: 1.1em;">è©¦åˆçµæœã‚’ä¿å­˜ãƒ»é›†è¨ˆ</button>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>3. ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <table id="rankingTable">
            <thead>
                <tr><th>é †ä½</th><th>åå‰</th><th>ç·åˆãƒã‚¤ãƒ³ãƒˆ</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="3">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // ã€é‡è¦ã€‘ã“ã“ã«ã‚ãªãŸã®GASï¼ˆã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªï¼‰ã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxfY1wyV4KC1Or1BbGgKFaOp7yqq1NmczEsjen4oht6-br5Et9iSuDNUSUlBbEfBmJw/exec"; 

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œ
        document.addEventListener("DOMContentLoaded", function() {
            initForm();      
            if (GAS_URL.includes("http")) {
                fetchRanking();
            } else {
                alert("GASã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰å†…ã®GAS_URLã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚");
            }
        });

        function initForm() {
            const mDiv = document.getElementById('memberInputs');
            const cDiv = document.getElementById('childrenInputs');

            // 10äººåˆ†ã®å…¥åŠ›æ 
            let mHtml = "";
            for (let i = 1; i <= 10; i++) {
                mHtml += `<input type="text" class="member-input" id="m${i}" placeholder="å‚åŠ è€… ${i}">`;
            }
            mDiv.innerHTML = mHtml;

            // å­4äººåˆ†ã®å…¥åŠ›æ 
            let cHtml = "";
            for (let i = 1; i <= 4; i++) {
                cHtml += `
                <div class="score-row">
                    <div>
                        ğŸƒ å­${i}: <select id="ko${i}Select" class="ko-sel"><option value="">é¸æŠ</option></select>
                        <select id="ko${i}Time" onchange="calculatePoints()">
                            <option value="0">3~2åˆ†(0pt)</option>
                            <option value="1">2~1åˆ†(1pt)</option>
                            <option value="2">1åˆ†~çµ‚äº†(2pt)</option>
                            <option value="3">é€ƒã’åˆ‡ã‚Š(3pt)</option>
                        </select>
                    </div>
                    <div class="bonus-group">
                        <label class="bonus-item"><input type="checkbox" id="ko${i}B1" onchange="calculatePoints()"> æ•µé™£(+0.5)</label>
                        <label class="bonus-item"><input type="checkbox" id="ko${i}B2" onchange="calculatePoints()"> æœ€æ•µé™£(+0.5)</label>
                    </div>
                </div>`;
            }
            cDiv.innerHTML = cHtml;
        }

        let scores = {};

        async function fetchRanking() {
            try {
                const response = await fetch(GAS_URL);
                scores = await response.json();
                updateRanking();
            } catch (e) {
                console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
                document.querySelector('#rankingTable tbody').innerHTML = '<tr><td colspan="3">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
            }
        }

        function updateMemberList() {
            const names = [];
            for (let i = 1; i <= 10; i++) {
                const val = document.getElementById(`m${i}`).value.trim();
                if (val) names.push(val);
            }
            
            const dropdowns = [document.getElementById('oniSelect'), ...document.querySelectorAll('.ko-sel')];
            dropdowns.forEach(select => {
                const currentVal = select.value;
                let html = '<option value="">é¸æŠ</option>';
                names.forEach(n => {
                    html += `<option value="${n}">${n}</option>`;
                });
                select.innerHTML = html;
                select.value = currentVal;
            });
            alert("ãƒ¡ãƒ³ãƒãƒ¼ã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«åæ˜ ã—ã¾ã—ãŸã€‚");
        }

        function calculatePoints() {
            let oniBonus = 0;
            for (let i = 1; i <= 4; i++) {
                const timeVal = parseInt(document.getElementById(`ko${i}Time`).value);
                if (timeVal === 0) oniBonus += 3;
                else if (timeVal === 1) oniBonus += 2;
                else if (timeVal === 2) oniBonus += 1;
            }
            document.getElementById('oniTotalDisplay').innerText = oniBonus;
            return oniBonus;
        }

        async function saveMatch() {
            const oniName = document.getElementById('oniSelect').value;
            if (!oniName) { alert("é¬¼ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

            const matchData = {
                oniName: oniName,
                oniPoints: calculatePoints(),
                children: []
            };

            for (let i = 1; i <= 4; i++) {
                const name = document.getElementById(`ko${i}Select`).value;
                if (!name) continue;
                let p = parseInt(document.getElementById(`ko${i}Time`).value);
                if (document.getElementById(`ko${i}B1`).checked) p += 0.5;
                if (document.getElementById(`ko${i}B2`).checked) p += 0.5;
                matchData.children.push({ name: name, points: p });
            }

            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerText;
            btn.innerText = "ä¿å­˜ä¸­...";
            btn.disabled = true;

            try {
                const resp = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(matchData) });
                if (resp.ok) {
                    alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
                    await fetchRanking();
                    resetForm();
                } else {
                    throw new Error();
                }
            } catch (e) {
                alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASã®è¨­å®šï¼ˆã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ï¼šå…¨å“¡ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function resetForm() {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`ko${i}B1`).checked = false;
                document.getElementById(`ko${i}B2`).checked = false;
                document.getElementById(`ko${i}Time`).value = "0";
                document.getElementById(`ko${i}Select`).value = "";
            }
            document.getElementById('oniSelect').value = "";
            calculatePoints();
        }

        function updateRanking() {
            const tbody = document.querySelector('#rankingTable tbody');
            tbody.innerHTML = '';
            
            const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
            
            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">è¨˜éŒ²ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            sorted.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${index + 1}</td><td>${item[0]}</td><td>${item[1].toFixed(1)} pt</td>`;
            });
        }
    </script>
</body>

</html>
